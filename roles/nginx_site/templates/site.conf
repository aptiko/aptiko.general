{% if server_aliases is defined -%}
server {
    listen              80;
    listen              [::]:80;
    {% if nginx_ssl %}
    listen              443 ssl;
    listen              [::]:443 ssl;
    {% endif %}
    {% if nginx_ssl and letsencrypt is sameas true -%}
    ssl_certificate     /etc/letsencrypt/live/{{ server_name }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ server_name }}/privkey.pem;
    {% elif nginx_ssl and letsencrypt %}
    ssl_certificate     /etc/letsencrypt/live/{{ letsencrypt }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ letsencrypt }}/privkey.pem;
    {% elif nginx_ssl %}
    ssl_certificate     /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
    {% endif -%}
    server_name         {{ server_aliases|join(" ") }};
    {% if force_ssl -%}
    return              302 https://{{ server_name }}$request_uri;
    {% else %}
    return              302 $scheme://{{ server_name }}$request_uri;
    {% endif %}
}

{% endif -%}
server {
    listen              80;
    listen              [::]:80;
    server_name         {{ server_name }} {{ server_aliases_without_redirect|default("")|join(" ") }};
    root                {{ document_root }};

    {% if force_ssl -%}
    return 302 https://{{ server_name }}$request_uri;
    {%- endif %}

    {% if extras is defined -%}
    {{ extras|replace("\n", "\n    ")|trim }}
    {%- endif %}

    {% if nonssl_extras is defined -%}
    {{ nonssl_extras|replace("\n", "\n    ")|trim }}
    {%- endif %}

    {% if not force_ssl -%}
    include /etc/nginx/snippets/{{ server_name }}/*.conf;
    {%- endif %}
}
{% if nginx_ssl -%}

server {
    listen              443 ssl http2;
    listen              [::]:443 ssl http2;
    {% if letsencrypt is sameas true -%}
    ssl_certificate     /etc/letsencrypt/live/{{ server_name }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ server_name }}/privkey.pem;
    {% elif letsencrypt|bool %}
    ssl_certificate     /etc/letsencrypt/live/{{ letsencrypt }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ letsencrypt }}/privkey.pem;
    {% else %}
    ssl_certificate     /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
    {% endif -%}
    gzip                off;  # Avoid CRIME exploit

    server_name         {{ server_name }} {{ server_aliases_without_redirect|default("")|join(" ") }};
    root                {{ document_root }};

    {% if extras is defined -%}
    {{ extras|replace("\n", "\n    ")|trim }}
    {%- endif %}

    {% if ssl_extras is defined -%}
    {{ ssl_extras|replace("\n", "\n    ")|trim }}
    {%- endif %}

    include /etc/nginx/snippets/{{ server_name }}/*.conf;
}
{% endif %}
